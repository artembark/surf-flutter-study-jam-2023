# Целевая платформа

!NOTE Я понизил зависимость от версии flutter для того, чтобы ускорить запуск без fvm и прочего, но не вернул обратно перед пушем. Люблю плагин Flutter-Toolkit который добавляет в контекстное меню build_runner rebuild, а его с fvm не соединить. По крайней мере я не задавался этим.

Разработка велась на эмуляторе iOS 16.2.

# Результаты

## Приложение для хранения билетов offline
Целью Study Jam 3 было создать приложение для загрузки и просмтора pdf файлов.

## Используемые библиотеки
- `flutter_bloc` - пакет виджетов для упрощения работы с пакетом `bloc`
- `shared_preferences` - пакет для доступа к локальному хранилищу
- `dio`- сетевой клиент для загрузки файла
- `freezed` - пакет для упрощения работы с иммутабельными классами
- `freezed_annotation` - пакет аннотаций для `freezed`
- `json_annotation` - пакет для аннотации сериализатора/десериализатора `json_serializable`, входящего в состав `freezed`
- `flutter_pdfview` - пакет для просмотра pdf в приложении
- `uuid` - пакет для генерации уникальных uuid (люблю как они выглядят =))
- `path_provider` - пакет для поиска стандартных директорий для хранения на платформах
- `build_runner` - пакет для кодогенерации

## Главный экран
На главном экране находится верхняя панель с названием экрана, список добавленных файлов и кнопка "Добавить".

Когда в приложении нет ни одного добавленного файла отображается информационное сообщение "Здесь пока ничего нет".

<p align="center">
  <img width="400" src="https://user-images.githubusercontent.com/30658712/230796354-dcdb014c-ac67-4b07-b73a-c90b300b4542.png">
</p>

### Боттомшит добавления файла
При нажатии на кнопку "Добавить" открывается боттомшит с текстовым полем для ввода URL загружаемого файла. Поведение клавиатуры в полном ролике в конце.

<p align="center">
  <img width="400" src="https://user-images.githubusercontent.com/30658712/230796585-401e2802-edfb-4ade-8c28-dc23d27e1a96.png">
</p>

#### Валидация полей
При попытке добавить URL происходят 2 проверки:
##### Проверка на пустое поле для ввода
<p align="center">
  <img width="400" src="https://user-images.githubusercontent.com/30658712/230796821-49252c5f-2d09-4355-8ad2-f1babd03f703.png">
</p>

##### Проверка на то, что добавляемая ссылка содержит pdf
<p align="center">
  <img width="400" src="https://user-images.githubusercontent.com/30658712/230796929-5555a66f-191c-4d73-bcda-e75b941f09fb.png">
</p>

#### Список файлов сохранятеся в хранилище SharedPreferences.

#### Вставка текста из буфера обмена (дополнение)
При открытии боттомшита, если он не пустой, происходит проверка есть ли в строке в буфере обмена расширение .pdf и происходит автоматическая подстановка в поле для добавдения URL.

<p align="center">
  <img width="400" src="https://user-images.githubusercontent.com/30658712/230797221-077beb4c-50a4-460a-b0f2-24f643d62e1b.gif">
</p>

#### Выбор категории при добавлении (дополнение)
В объекте билета есть параметр тип билета, который можно выбрать нажав на соответсвующий чип. От него зависит иконка в списке на главном экране.

<p align="center">
  <img width="400" src="https://user-images.githubusercontent.com/30658712/230797390-4ba42f42-abf1-4fce-9007-f4134a14f2b7.gif">
</p>

#### Удаление файла
Тут печаль. Реализовал через Dismissable. Но не успел должным образом протестить. В итоге после удаления и перезапуска приложения или при последующем добавлении файла есть баг со стейтом.
PS. И про снекбар не прочитал. Лучше бы его сделал, чем удаление =) Тем более что удаление как раз сопровождается снекбаром.

## Загрузка файлов
Загрузка файлов реализована через Dio. Прогресс отслеживается через колбек метода загрузки dio.download и передается в Stream репозитория, на который подписан кубит. На экране в блокбилдере происходит перевод загруженных и суммарного количества байт в подходящие единицы с помощью с помощью честно унесенной со стековерфлоу функции перевода (работает - не трогай =))
Реализованы состояния загрузки, которые переключаются в процессе загрузки, и от которых зависят иконка и текстовая подпись состояния. Повторный клик на загрузку после начала заблокирован. НО! Пока эксперементиовал с кнопкой паузы, так как виджет иконки с onTap тут один и тот же и только сама иконка от состояния меняется, то убрал и не вернул перед пушем обратно блокировку запуска загрузки файла, когда он находится в сотсоянии dowonloaded.

<p align="center">
  <img width="400" src="https://user-images.githubusercontent.com/30658712/230798271-4a4670db-412e-45f9-b862-6a4b10d17155.gif">
</p>

### Состояние ошибки
При возникновении ошибки в процессе загрузки отображается соответствующий статус.
<p align="center">
  <img width="400" src="https://user-images.githubusercontent.com/30658712/230798413-5828fc58-c434-4343-833f-f23819e7a932.gif">
</p>

## Экран просмотра
Экран просмотра реализован с помощью пакета `flutter_pdfview`. Отдельный экран на который передаются название и путь файла.

<p align="center">
  <img width="400" src="https://user-images.githubusercontent.com/30658712/230797799-9c4de2d9-16be-4564-a3fb-910fb02249c1.gif">
</p>

## TODO
- [ ] вернуть блокировку загрузки файла когда он уже а в состоянии downloaded
- [ ] поправить swipe to delete
- [ ] не успел победить паузу и дозагрузку файла. Но тема просто огонь. Только за этот кейс огромное вам спасибо) Насчет дозагрузки все понятно, у Dio можно передать в Options диапазон байт для загрузки, также в официальном репозитории в примерах есть вариант со склеиванием файла. Именно этот пример у меня сейчас и находится в сервисе по загрузке файла, хоть его функционалом я в итоге не пользуюсь. Насчет паузы попробовал через CancelToken но не успел проработать.

# Ссылки на демонстрацию работы/скриншоты

## Full demo
Задержки на копирование реальных ссылок. На демо также можно посмотерть поведение боттомшита при появлении клавиатуры.

[Полное видео демонстрации работы](https://disk.yandex.ru/i/s5GW_KvX8u2VDg)
